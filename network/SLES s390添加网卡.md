# SLES 12 s390x如何添加一张OSA卡

## 写在开头的话

本人写的文章只是个人工作经验的免费分享，不代表本人供职公司的观点，不承担由此带来的任何责任。

### 永久添加 OSA 以太网口

如果你要在 SUSE  s390x上永久添加 一个 OSA 的以太网接口，步骤如下：

#### 1.把OSA地址添加上去

默认的情况，系统是屏蔽掉所有 IO 地址的（LinuxOne 上面实在是太多 IO 端口了），你只有把屏蔽去掉才行。

```bash
~ # chzdev -e 800-802
QETH device 0.0.0800:0.0.0801:0.0.0802 configured
```

这信息保存在/etc/udev/rules.d/.

**执行命令前：**

```bash
~ # cat /etc/udev/rules.d/41-cio-ignore.rules
# Generated by chzdev
ACTION=="add", SUBSYSTEM=="subsystem", KERNEL=="ccw", RUN{program}+="/bin/sh -c 'echo free 0440-0442,04f0-04f2,da43,dd42 > /proc/cio_ignore'"
```

**执行命令后：**

这时如果你去看下/etc/udev/rules.d/下面的xx-cio-ignore.rules文件的话，你会看到800-802已经添加上去。

```bash
~ # cat /etc/udev/rules.d/41-cio-ignore.rules
# Generated by chzdev
ACTION=="add", SUBSYSTEM=="subsystem", KERNEL=="ccw", RUN{program}+="/bin/sh -c 'echo free 0440-0442,04f0-04f2,0800-0802,da43,dd42 > /proc/cio_ignore'"
```

如果你去看/etc/udev/rules.d/下面的 xxpersistent-net.rules文件的话，你会看到800被分配到的接口名是 eth2。

```bash
# S/390 qeth device at 0.0.0800
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="qeth", ATTR{dev_id}=="0x0", KERNELS=="0.0.0800", ATTR{type}=="1", KERNEL=="eth*", NAME="eth2"
```

#### 2. 编辑网络配置文件

```bash
~ # vi /etc/sysconfig/network/ifcfg-eth2
BOOTPROTO='static'
STARTMODE='auto'
IPADDR='192.168.1.102/24'
NAME='OSA Express Network card (0.0.0440)
```

####  3. 重启网络服务，生效了

```bash
~ # service network restart
~ # ifconfig
eth2      Link encap:Ethernet  HWaddr 02:00:00:74:0A:3A
          inet addr:192.168.1.102  Bcast:192.168.1.255  Mask:255.255.255.0
          inet6 addr: fe80::ff:fe74:a3a/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:13 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:894 (894.0 b)
```



### 临时添加 OSA 以太网口

#### 1.  临时把OSA地址添加上去

```bash
~ # cio_ignore -r 803-805
```

#### 2. 临时创建OSA 设备

```bash
# znetconf -a 803
Scanning for network devices...
Successfully configured device 0.0.0803 (eth4)
```

#### 3. 临时添加 IP 地址

```bash
ip addr add 10.10.140.3 brd 10.10.140.1 dev eth4
```

#### 4. 启动端口

```
ip link set dev eth4 up
ifconfig
eth4      Link encap:Ethernet  HWaddr 02:00:00:5D:6F:7F
          inet addr:10.10.140.3  Bcast:10.10.140.1  Mask:255.255.255.255
          inet6 addr: fe80::ff:fe5d:6f7f/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:7 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 b)  TX bytes:586 (586.0 b)
```

